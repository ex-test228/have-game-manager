<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <h1>ボードゲーム管理</h1>

  <section>
    <h2>ゲーム一覧</h2>
    <table>
      <thead>
        <tr>
          <th>ゲーム名</th>
          <th>拡張</th>
          <th>作者</th>
          <th>人数</th>
          <th>プレイ時間</th>
          <th>URL</th>
          <th>変更</th>
          <th>削除</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
  </section>


  <h2>ゲーム追加</h2>
  <label for="name">ゲーム名:</label>
  <input type="text" id="name" name="name" value="testname" required>
  <label for="author">作者:</label>
  <input type="text" id="author" name="author" value="testauthor" required>
  <label for="peaple">人数:</label>
  <input type="number" id="peaple" name="peaple" value="2">
  <label for="time">プレイ時間:</label>
  <input type="text" id="time" name="time" value="30">
  <label for="url">URL:</label>
  <input type="text" id="url" name="url">
  <button type="submit" id="addButton">追加</button>

    <h2>ゲーム追加(拡張)</h2>
  <label for="nameToExpansion">ゲーム名:</label>
  <input type="text" id="nameToExpansion" name="nameToExpansion" value="testname" required>
  <label for="expansionName">拡張名:</label>
  <input type="text" id="expansionName" name="expansionName" value="testExpansionName" required>
  <button type="submit" id="addExpansionButton">追加</button>

  <script>

    addEventListener('DOMContentLoaded', () => {
      // ゲーム一覧を取得して表示する処理
      fetch('http://localhost:8080/api/products',
        { method: 'GET' })
        .then(response => response.json())
        .then(data => {
          console.log('Fetched games:', data);
          const tbody = document.querySelector('table tbody');
          data.forEach(game => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td contenteditable="true">${game.name}</td>
                <td>
              ${game.expansion ? `
               <details>
              <summary>開く</summary>
              ${game.expansion}
              </details>
                ` : ''}
                <button class="addFormButton" data-id="${game.id}">拡張追加</button>
               </td>
              <td contenteditable="true">${game.author}</td>
              <td contenteditable="true">${game.howManyPeple}</td>
              <td contenteditable="true">${game.playTime}</td>
              <td contenteditable="true"><a href="${game.url}">${game.url}</a></td>
              <td ><button class="editButton" data-id="${game.id}">変更</button></td>
              <td><button class="deleteButton" data-id="${game.id}">削除</button></td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(error => console.error('Error fetching games:', error));
    });

    const addButton = document.getElementById('addButton');

    addButton.addEventListener('click', () => {
      const addName = document.getElementById('name').value;
      const addAuthor = document.getElementById('author').value;
      const addHowManyPeple = document.getElementById('peaple').value;
      const addPlayTime = document.getElementById('time').value;
      const addUrl = document.getElementById('url').value;

      // 更新データ
      const addData = {
        name: addName,
        author: addAuthor,
        howManyPeple: addHowManyPeple,
        playTime: addPlayTime,
        url: addUrl
      };

      fetch('http://localhost:8080/api/products', {
        method: 'POST', // <-- POSTメソッドを指定
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(addData) // <-- 更新するJSONデータをボディに含める
      })
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error('Add failed: ' + response.status);
        })
        .then(data => console.log('Add product:', data))
        .catch(error => console.error('Error:', error));
    })

    addEventListener('click', (event) => {
      if (event.target.classList.contains('deleteButton')) {
        const gameId = event.target.getAttribute('data-id');
        fetch(`http://localhost:8080/api/products/${gameId}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (response.ok) {
              event.target.closest('tr').remove();
              console.log('Game deleted successfully');
            } else {
              throw new Error('Delete failed: ' + response.status);
            }
          })
          .catch(error => console.error('Error deleting game:', error));
      }
    });

    addEventListener('click', (event) => {
      if (event.target.classList.contains('editButton')) {
        const gameId = event.target.getAttribute('data-id');
        const row = event.target.closest('tr');
        const newName = row.children[0].textContent;
        const newAuthor = row.children[2].textContent;
        const newHowManyPeple = row.children[3].textContent;
        const newPlayTime = row.children[4].textContent;
        const newUrl = row.children[5].textContent;

        const updatedData = {
          name: newName,
          author: newAuthor,
          howManyPeple: newHowManyPeple,
          playTime: newPlayTime,
          url: newUrl
        };

        console.log('Updating game with ID:', gameId, 'Data:', updatedData);

        fetch(`http://localhost:8080/api/products/${gameId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData) // <-- 更新するJSONデータをボディに含める
        })
          .then(response => {
            if (response.ok) {
              console.log('Game update successfully');
            } else {
              throw new Error('Update failed: ' + response.status);
            }
          })
          .catch(error => console.error('Error updating game:', error));
      }
    });

    addEventListener('click', (event) => {
      if (event.target.classList.contains('addFormButton')) {
        let expansionName = prompt("追加する拡張の名前", "testex");
        if (expansionName || expansionName.trim() !== "") {
        const gameId = event.target.getAttribute('data-id');
        const row = event.target.closest('tr');
        const newExpansionName = expansionName;

        const updatedData = {
          game_id: gameId,
          name: newExpansionName
        };

        console.log('Updating game with ID:', gameId, 'Data:', updatedData);

        fetch(`http://localhost:8080/api/Expansions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData) // <-- 更新するJSONデータをボディに含める
        })
          .then(response => {
            if (response.ok) {
              console.log('Game update successfully');
            } else {
              throw new Error('Update failed: ' + response.status);
            }
          })
          .catch(error => console.error('Error updating game:', error));
      
      }
    }
    });


    addEventListener('click', (event) => {
      if (event.target.classList.contains('addExpansionButton')) {
        const gameId = event.target.getAttribute('data-id');
        const row = event.target.closest('tr');
        const newExpansionName = row.children[0].textContent;

        const updatedData = {
          name: newExpansionName
        };

        console.log('Updating game with ID:', gameId, 'Data:', updatedData);

        fetch(`http://localhost:8080/api/products/${gameId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData) // <-- 更新するJSONデータをボディに含める
        })
          .then(response => {
            if (response.ok) {
              console.log('Game update successfully');
            } else {
              throw new Error('Update failed: ' + response.status);
            }
          })
          .catch(error => console.error('Error updating game:', error));
      }
    });
  </script>
</body>

</html>